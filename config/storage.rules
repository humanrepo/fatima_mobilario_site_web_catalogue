// Règles de sécurité Firebase Storage pour Fatima Mobiliário
// Ces règles contrôlent l'accès aux fichiers uploadés (images des produits)
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Dossier des images de produits
    match /products/{productId}/{imageId} {
      // Lecture publique pour toutes les images de produits
      allow read: if true;
      
      // Écriture autorisée uniquement pour les administrateurs
      allow write: if request.auth != null && 
                      request.auth.token.role == 'admin' &&
                      // Validation du type de fichier (images uniquement)
                      request.resource.contentType.matches('image/.*') &&
                      // Limite de taille : 10MB maximum
                      request.resource.size < 10 * 1024 * 1024;
      
      // Suppression autorisée pour les admins
      allow delete: if request.auth != null && 
                       request.auth.token.role == 'admin';
    }
    
    // Dossier des miniatures générées automatiquement
    match /thumbnails/{productId}/{imageId} {
      // Lecture publique pour optimiser les performances
      allow read: if true;
      
      // Écriture autorisée pour le système (Cloud Functions)
      allow write: if request.auth != null;
    }
    
    // Dossier temporaire pour les uploads
    match /temp/{userId}/{fileName} {
      // Accès limité à l'utilisateur propriétaire (admin)
      allow read, write: if request.auth != null && 
                            request.auth.uid == userId &&
                            request.auth.token.role == 'admin' &&
                            request.resource.size < 10 * 1024 * 1024;
      
      // Auto-suppression après 24h (géré par Cloud Functions)
      allow delete: if true;
    }
    
    // Tous les autres chemins sont interdits
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}